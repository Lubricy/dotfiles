#!/usr/bin/env bash

# nix-depend: jq curl pass unstable.matugen swww

CACHE="${XDG_CACHE_DIR:-$HOME/.cache}/wallpaper"
WALLPAPER="${CACHE}/matugen-wallpaper-$(date +%Y%m%d_%H%M%S)"
API_KEY="${PEXEL_API_KEY:-$(pass t/pexel)}"

mkdir -p "$CACHE"

TOTAL=$(curl -H "Authorization: $API_KEY" \
  -fsSL -G \
  --data-urlencode "query=background" \
  --data-urlencode "orientation=landscape" \
  --data-urlencode "per_page=1" \
  "https://api.pexels.com/v1/search" \
  | jq -r '.total_results')

SELECTED=$((RANDOM % TOTAL))
echo "$SELECTED"

curl -L "$(curl -H "Authorization: $API_KEY" \
  -fsSL -G \
  --data-urlencode "query=background" \
  --data-urlencode "orientation=landscape" \
  --data-urlencode "per_page=1" \
  --data-urlencode "page=$SELECTED" \
  "https://api.pexels.com/v1/search" \
  | jq -r '.photos[0].src.landscape')" \
  -o "$WALLPAPER"

matugen -d image "$WALLPAPER"
