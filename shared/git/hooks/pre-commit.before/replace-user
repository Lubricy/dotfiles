#!/usr/bin/env bash

set -eo pipefail

EXIT_CODE=0

git diff --staged --name-only --diff-filter=ACM | while read -r FILE; do
  # Skip if file doesn't exist (e.g., was deleted)
  [[ ! -e "$FILE" ]] && continue

  if [[ -L "$FILE" ]]; then
    # It's a symlink — resolve to target
    TARGET=$(readlink "$FILE")
    # Ensure target exists
    [[ ! -e "$TARGET" ]] && echo "Warning: symlink '$FILE' points to non-existent target '$TARGET'" >&2 && continue

    # Edit the target file
    sed -i'' "s#$HOME#~#g" "$TARGET"
    # Add the target to git (not the symlink itself)
    git add "$TARGET"
  elif [[ -f "$FILE" ]]; then
    # Regular file — edit directly
    sed -i'' "s#$HOME#~#g" "$FILE"
    git add "$FILE"
  else
    # Skip directories, devices, etc.
    continue
  fi
done

exit "$EXIT_CODE"
